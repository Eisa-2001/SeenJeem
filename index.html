<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø³ÙŠÙ† Ø¬ÙŠÙ… â€” Ù†Ø³Ø®Ø© ÙƒØ§Ù…Ù„Ø©</title>
<style>
  :root{
    --bg:#0b0f14; --card:#121826; --panel:#0b1220; --line:#263042;
    --text:#e5e7eb; --muted:#9aa4b2; --accent:#f97316; --red:#ef4444; --ok:#22c55e;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#070a10,#0b0f14);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  .card{background:rgba(18,24,38,.92);border:1px solid var(--line);border-radius:16px;padding:12px}
  header{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);
    background:var(--panel);color:var(--text);cursor:pointer;font-weight:900}
  .btn:hover{filter:brightness(1.08)}
  .btnOrange{background:rgba(249,115,22,.14);border-color:rgba(249,115,22,.35)}
  .btnRed{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}
  .btnGreen{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
  .pill{padding:7px 10px;border-radius:999px;background:#1f2937;border:1px solid var(--line);color:var(--muted);font-size:13px}
  .turnPill{padding:8px 12px;border-radius:999px;background:rgba(249,115,22,.15);border:1px solid rgba(249,115,22,.35);font-weight:950}
  .muted{color:var(--muted);font-size:12px}
  input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:var(--panel);color:var(--text)}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}

  /* Picker */
  .selectorGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  @media(max-width:980px){.selectorGrid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:520px){.selectorGrid{grid-template-columns:1fr}}
  .pick{
    background:var(--panel);border:1px solid var(--line);border-radius:14px;
    padding:10px;display:flex;gap:10px;align-items:center
  }
  .pick input{width:auto;transform:scale(1.1)}

  /* Game layout */
  .grid{display:grid;grid-template-columns:1fr 430px;gap:14px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .boardWrap{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media(max-width:980px){.boardWrap{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:520px){.boardWrap{grid-template-columns:1fr}}
  .cat{background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:10px}
  .catTitle{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
  .catTitle b{font-size:15px}
  .pointsGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .pBtn{
    padding:12px 10px;border-radius:999px;border:1px solid var(--line);
    background:rgba(255,255,255,.06);color:#ff3b30;font-weight:950;font-size:16px;
    cursor:pointer;text-align:center; user-select:none;
  }
  .pBtn:hover{border-color:rgba(96,165,250,.5)}
  .pBtn.used{opacity:.35;cursor:not-allowed;text-decoration:line-through}
  .pBtn.big{grid-column:1/-1}

  /* Teams */
  .teams{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:520px){.teams{grid-template-columns:1fr}}
  .team{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:10px}
  .team.active{outline:2px solid rgba(249,115,22,.55)}
  .team h4{margin:0 0 6px;font-size:14px}
  .score{font-size:34px;font-weight:950;margin:0}
  .helpRow{display:flex;gap:10px;margin-top:8px}
  .helpBtn{
    flex:1;padding:10px;border-radius:999px;border:1px solid var(--line);
    background:rgba(255,255,255,.06);cursor:pointer;font-weight:900
  }
  .helpBtn.used{opacity:.35;cursor:not-allowed}

  /* Modal */
  .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:14px;z-index:50}
  .modal{max-width:820px;width:100%;background:rgba(18,24,38,.98);border:1px solid var(--line);border-radius:18px;padding:14px}
  .modalTop{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
  .qCat{color:var(--muted);font-size:13px}
  .qText{font-size:20px;line-height:1.8;white-space:pre-wrap;margin-top:10px}
  .answer{margin-top:10px;border:1px dashed rgba(249,115,22,.45);border-radius:14px;padding:10px;background:rgba(249,115,22,.10);display:none}
  .answer.show{display:block}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas;font-size:12px;padding:2px 6px;border:1px solid var(--line);border-radius:8px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="row">
      <button class="btn" id="btnPicker">ğŸ›ï¸ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø± ØªØµÙ†ÙŠÙØ§Øª)</button>
      <button class="btn" id="btnResetBoard">â™»ï¸ ØªØµÙÙŠØ± Ø§Ù„Ù„ÙˆØ­Ø©</button>
      <button class="btn btnRed" id="btnHardReset">ğŸ§¨ ØªØµÙÙŠØ± ÙƒØ§Ù…Ù„</button>
      <span class="pill">Ø§Ø®ØªØµØ§Ø±Ø§Øª: <span class="kbd">A</span> Ø¥Ø¬Ø§Ø¨Ø© â€” <span class="kbd">N</span> Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯ â€” <span class="kbd">Esc</span> Ø¥ØºÙ„Ø§Ù‚ â€” <span class="kbd">T</span> ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±</span>
    </div>
    <div class="turnPill" id="turnPill">Ø¯ÙˆØ±: â€”</div>
  </header>

  <!-- PICKER -->
  <div class="card" id="pickerCard">
    <div class="row" style="justify-content:space-between">
      <div>
        <h2 style="margin:0 0 6px">Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
        <div class="muted">Ø§Ø®ØªØ± Ù…Ù† <b>3</b> Ø¥Ù„Ù‰ <b>6</b> ØªØµÙ†ÙŠÙØ§Øª. (Ø¢Ø®Ø± Ø§Ø®ØªÙŠØ§Ø± ÙŠÙ†Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</div>
      </div>
      <div class="pill">Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©: <b id="pickedCount">0</b>/6</div>
    </div>

    <div class="row" style="margin-top:10px">
      <div style="flex:1;min-width:220px">
        <label>Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Ù‚</label>
        <select id="teamCount">
          <option value="2" selected>2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
      </div>
      <div style="flex:1;min-width:220px">
        <label>Ù…Ø¯Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ (Ø«Ø§Ù†ÙŠØ©)</label>
        <select id="timerLen">
          <option value="20">20</option>
          <option value="30" selected>30</option>
          <option value="45">45</option>
          <option value="60">60</option>
        </select>
      </div>
      <div style="flex:1;min-width:220px">
        <label>Ø£ØµÙˆØ§Øª</label>
        <select id="soundOn">
          <option value="on" selected>ØªØ´ØºÙŠÙ„</option>
          <option value="off">Ø¥ÙŠÙ‚Ø§Ù</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button class="btn" id="btnRandomCats">ğŸ² Ø¹Ø´ÙˆØ§Ø¦ÙŠ</button>
      <button class="btn btnOrange" id="btnStart">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© ğŸ®</button>
    </div>

    <div class="selectorGrid" id="pickerList"></div>

    <div class="muted" style="margin-top:12px">
      Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ Ø§Ø®ØªØ±Øª ØªØµÙ†ÙŠÙ ÙˆÙ…Ø§ Ø¹Ù†Ø¯Ù‡ Ø£Ø³Ø¦Ù„Ø© ÙƒÙØ§ÙŠØ©ØŒ Ø§Ù„Ù„Ø¹Ø¨Ø© ØªØ³ØªØ®Ø¯Ù… â€œØ«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©â€ ÙƒØ¨Ø¯ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù†ÙØ³ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù†Ù‚Ø§Ø·.
    </div>
  </div>

  <!-- GAME -->
  <div class="grid" id="gameArea" style="display:none">
    <div class="card">
      <div class="boardWrap" id="board"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Ø§Ù„ÙØ±Ù‚ + Ø§Ù„Ù†Ù‚Ø§Ø·</h3>
      <div class="pill" style="text-align:center;margin-bottom:10px">â±ï¸ Ø§Ù„ÙˆÙ‚Øª: <b id="timer">â€”</b></div>
      <div class="teams" id="teamsWrap"></div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSwitchTurn">ğŸ” Ø¨Ø¯Ù‘Ù„ Ø§Ù„Ø¯ÙˆØ±</button>
        <button class="btn" id="btnStats">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
      </div>

      <div class="muted" style="margin-top:10px">
        âœ… Ø§Ù„Ø®Ø§Ù†Ø© ØªÙÙ‚ÙÙ„ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§.<br>
        âœ… Ø¨Ø¹Ø¯ â€œØ®Ø·Ø£â€ Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„ØŒ ØªÙ‚Ø¯Ø± ØªØ³Ù…Ø­ Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ ÙŠØ¬Ø§ÙˆØ¨ ÙˆÙŠØ£Ø®Ø° Ù†ÙØ³ Ø§Ù„Ù†Ù‚Ø§Ø· (Ø³Ø±Ù‚Ø©).<br>
        âœ… Ø¯Ø§Ø®Ù„ Ù†ÙØ³ (Ø§Ù„ØªØµÙ†ÙŠÙ+Ø§Ù„Ù†Ù‚Ø§Ø·) Ù…Ø§ ÙŠØªÙƒØ±Ø± Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ù…Ø§ ØªØ®Ù„Øµ ÙƒÙ„ Ø£Ø³Ø¦Ù„ØªÙ‡.
      </div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modalBack" id="modalBack">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalTop">
      <div>
        <div class="qCat" id="mCat">â€”</div>
        <b id="mPts" style="font-size:18px">â€”</b>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" id="btnNewQ">ğŸ² Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</button>
        <button class="btn" id="btnToggleA">ğŸ‘ï¸ Ø¥Ø¬Ø§Ø¨Ø©</button>
        <button class="btn btnRed" id="btnClose">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

    <div class="qText" id="mQ">â€”</div>

    <div class="answer" id="answerBox">
      <b>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</b>
      <div id="mA" style="margin-top:6px"></div>
    </div>

    <div class="row" style="margin-top:10px;justify-content:space-between">
      <span class="pill" id="mMeta">â€”</span>
      <span class="pill">Ù…ÙØ§ØªÙŠØ­: <span class="kbd">N</span> Ø¬Ø¯ÙŠØ¯ â€” <span class="kbd">A</span> Ø¥Ø¬Ø§Ø¨Ø© â€” <span class="kbd">Esc</span> Ø¥ØºÙ„Ø§Ù‚</span>
    </div>

    <div class="row" style="margin-top:12px;justify-content:space-between">
      <button class="btn btnGreen" id="btnCorrect">ØµØ­ âœ…</button>
      <button class="btn btnRed" id="btnWrong">Ø®Ø·Ø£ âŒ</button>
    </div>

    <div class="row" id="stealRow" style="margin-top:10px;display:none;justify-content:space-between">
      <button class="btn btnOrange" id="btnStealTry">ğŸ“Œ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ (Ø³Ø±Ù‚Ø©)</button>
      <button class="btn" id="btnNoPoints">Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø¯ÙˆÙ† Ù†Ù‚Ø§Ø·</button>
    </div>
  </div>
</div>

<!-- Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ -->
<script src="./bank.js?v=3" defer></script>

<script defer>
/* ============== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ============== */
const ALL_CATEGORIES = [
  "Ø«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©","Ø¬ØºØ±Ø§ÙÙŠØ§","ØªØ§Ø±ÙŠØ®","Ø¹Ù„ÙˆÙ…","ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§","ÙƒÙ…Ø¨ÙŠÙˆØªØ±","Ø¥Ù†ØªØ±Ù†Øª ÙˆØ£Ù…Ù†","Ù‡ÙˆØ§ØªÙ",
  "Ø¯ÙŠÙ† (Ø¹Ø§Ù…)","Ø§Ù„Ù‚Ø±Ø¢Ù†","Ø§Ù„Ø³ÙŠØ±Ø©","Ø§Ù„ØµØ­Ø§Ø¨Ø©","ÙÙ‚Ù‡ (Ø¹Ø§Ù…)",
  "Ø¯ÙˆÙ„ ÙˆØ¹ÙˆØ§ØµÙ…","Ø£Ø¹Ù„Ø§Ù… ÙˆØ¯ÙˆÙ„","Ø³ÙŠØ§Ø³Ø© (Ø¹Ø§Ù…)","Ù…Ù†Ø¸Ù…Ø§Øª Ø¯ÙˆÙ„ÙŠØ©","Ø§Ù‚ØªØµØ§Ø¯ (Ø¹Ø§Ù…)",
  "Ø±ÙŠØ§Ø¶Ø© (Ø¹Ø§Ù…)","ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù…","Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ","ÙƒØ£Ø³ Ø§Ù„Ø¹Ø§Ù„Ù…","ÙƒØ±Ø© Ø§Ù„Ø³Ù„Ø©","UFC",
  "Ø³ÙŠØ§Ø±Ø§Øª","Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³ÙŠØ§Ø±Ø§Øª","Ø¹Ù„Ø§Ù…Ø§Øª ØªØ¬Ø§Ø±ÙŠØ©",
  "Ø£ÙÙ„Ø§Ù… (Ø¹Ø§Ù…)","Ù…Ø³Ù„Ø³Ù„Ø§Øª (Ø¹Ø§Ù…)","Ù…Ù…Ø«Ù„ÙŠÙ†","Ù…Ø®Ø±Ø¬ÙŠÙ†",
  "Ø£Ù†Ù…ÙŠ (Ø¹Ø§Ù…)","Attack on Titan","Naruto","One Piece","Bleach","Jujutsu Kaisen","Chainsaw Man",
  "Ø£Ù„ØºØ§Ø²","Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©","Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ (Ø¹Ø§Ù…)"
];

const BANK = (window.BANK && Array.isArray(window.BANK)) ? window.BANK : [];

/* ============== Ø£Ø¯ÙˆØ§Øª ============== */
const $ = (id)=>document.getElementById(id);
function key(cat,pts){ return `${cat}|${pts}`; }
function beep(type="ok"){
  if($("soundOn").value==="off") return;
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type="sine";
    o.frequency.value = (type==="ok"? 740 : 220);
    o.connect(g); g.connect(ctx.destination);
    g.gain.value=0.06;
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
  }catch(e){}
}
function showStealOptions(show){
  const row = $("stealRow");
  if(!row) return;
  row.style.display = show ? "flex" : "none";
}
function countForCat(cat){
  return BANK.filter(x=>x.cat===cat).length;
}

/* ============== Ø§Ù„Ø­Ø§Ù„Ø© ============== */
const state = {
  selectedCats: [],
  gameCats: [],
  teamCount: 2,
  turn: 1,
  scores: {},
  usedCells: new Set(),
  usedByCatPts: new Map(),
  current: {cat:null, pts:null, idx:null},
  helpsUsed: {},
  timer:{id:null,left:0},
  stealMode:false,
  firstTeamTurn:null
};

/* ============== Ø­ÙØ¸/ØªØ­Ù…ÙŠÙ„ ØªØµÙ†ÙŠÙØ§Øª ============== */
function loadSavedCats(){
  try{
    const raw = localStorage.getItem("seenjeem_lastCats");
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(Array.isArray(arr)) return arr.filter(x=>ALL_CATEGORIES.includes(x));
  }catch(e){}
  return [];
}
function saveCats(arr){
  try{ localStorage.setItem("seenjeem_lastCats", JSON.stringify(arr)); }catch(e){}
}

/* ============== Picker ============== */
function buildPicker(){
  const list = $("pickerList");
  list.innerHTML="";
  state.selectedCats = [];

  const saved = loadSavedCats();

  ALL_CATEGORIES.forEach(cat=>{
    const div = document.createElement("div");
    div.className="pick";

    const cb = document.createElement("input");
    cb.type="checkbox";
    cb.value=cat;

    if(saved.includes(cat) && state.selectedCats.length < 6){
      cb.checked = true;
      state.selectedCats.push(cat);
    }

    cb.addEventListener("change", ()=>{
      if(cb.checked){
        if(state.selectedCats.length >= 6){
          cb.checked=false; alert("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 6 ØªØµÙ†ÙŠÙØ§Øª"); return;
        }
        if(!state.selectedCats.includes(cat)) state.selectedCats.push(cat);
      }else{
        state.selectedCats = state.selectedCats.filter(x=>x!==cat);
      }
      $("pickedCount").textContent = state.selectedCats.length;
    });

    const info = document.createElement("div");
    info.innerHTML = `<b>${cat}</b><div class="muted">${countForCat(cat)} Ø³Ø¤Ø§Ù„ ÙÙŠ Ø§Ù„Ø¨Ù†Ùƒ</div>`;

    div.appendChild(cb);
    div.appendChild(info);
    list.appendChild(div);
  });

  $("pickedCount").textContent = state.selectedCats.length;
}

function pickRandomCats(){
  const n = Math.floor(Math.random()*(6-3+1))+3;
  const shuffled = [...ALL_CATEGORIES].sort(()=>Math.random()-0.5);
  const chosen = shuffled.slice(0,n);

  state.selectedCats = [];
  const cbs = $("pickerList").querySelectorAll("input[type=checkbox]");
  cbs.forEach(cb=>{
    cb.checked = false;
    if(chosen.includes(cb.value)){
      cb.checked = true;
      state.selectedCats.push(cb.value);
    }
  });
  $("pickedCount").textContent = state.selectedCats.length;
}

/* ============== Teams ============== */
function buildTeams(){
  const wrap = $("teamsWrap");
  wrap.innerHTML="";
  state.teamCount = Number($("teamCount").value);
  state.scores = {};
  state.helpsUsed = {};
  state.turn = 1;

  for(let t=1;t<=state.teamCount;t++){
    state.scores[t]=0;
    state.helpsUsed[t]={hint:false,pass:false};

    const box = document.createElement("div");
    box.className = "team" + (t===1?" active":"");
    box.id = "teamBox_"+t;

    box.innerHTML = `
      <label>Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ ${t}</label>
      <input id="teamName_${t}" value="ÙØ±ÙŠÙ‚ ${t}">
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <div>
          <div class="muted">Ø§Ù„Ù†Ù‚Ø§Ø·</div>
          <p class="score" id="teamScore_${t}">0</p>
        </div>
        <div class="pill">Ù…Ø³Ø§Ø¹Ø¯Ø§Øª: <b id="helpState_${t}">2</b>/2</div>
      </div>
      <div class="helpRow">
        <button class="helpBtn" id="hintBtn_${t}">ğŸ’¡ ØªÙ„Ù…ÙŠØ­</button>
        <button class="helpBtn" id="passBtn_${t}">â­ï¸ ØªÙ…Ø±ÙŠØ±</button>
      </div>
    `;
    wrap.appendChild(box);

    $("hintBtn_"+t).addEventListener("click", ()=>useHelp("hint", t));
    $("passBtn_"+t).addEventListener("click", ()=>useHelp("pass", t));
  }
  syncTurnPill();
}

function activeTeamName(){
  const el = $("teamName_"+state.turn);
  return el ? (el.value || ("ÙØ±ÙŠÙ‚ "+state.turn)) : ("ÙØ±ÙŠÙ‚ "+state.turn);
}

function syncTurnPill(){
  $("turnPill").textContent = `Ø¯ÙˆØ±: ${activeTeamName()}`;
  for(let t=1;t<=state.teamCount;t++){
    const b = $("teamBox_"+t);
    if(b) b.classList.toggle("active", t===state.turn);
    const remaining = 2 - (state.helpsUsed[t].hint?1:0) - (state.helpsUsed[t].pass?1:0);
    const hs = $("helpState_"+t);
    if(hs) hs.textContent = remaining;
  }
}

function switchTurn(){
  state.turn++;
  if(state.turn > state.teamCount) state.turn=1;
  syncTurnPill();
}

/* ============== Board ============== */
function buildBoard(){
  const board = $("board");
  board.innerHTML="";
  state.usedCells.clear();
  state.usedByCatPts.clear();

  state.gameCats.forEach(cat=>{
    const c = document.createElement("div");
    c.className="cat";
    c.innerHTML = `
      <div class="catTitle">
        <b>${cat}</b>
        <span class="muted">${countForCat(cat)} Ø³Ø¤Ø§Ù„</span>
      </div>
      <div class="pointsGrid">
        <div class="pBtn" data-cat="${cat}" data-pts="200">200</div>
        <div class="pBtn" data-cat="${cat}" data-pts="400">400</div>
        <div class="pBtn big" data-cat="${cat}" data-pts="600">600</div>
      </div>
    `;
    board.appendChild(c);
  });

  board.querySelectorAll(".pBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      if(btn.classList.contains("used")) return;
      openCell(btn.getAttribute("data-cat"), Number(btn.getAttribute("data-pts")), btn);
    });
  });
}

/* ============== Questions (No repeat per cat+pts) ============== */
function pickQuestion(cat, pts){
  const pool = BANK.map((x,i)=>({x,i})).filter(o=>o.x.cat===cat && o.x.pts===pts).map(o=>o.i);
  const fallback = BANK.map((x,i)=>({x,i})).filter(o=>o.x.cat==="Ø«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©" && o.x.pts===pts).map(o=>o.i);
  const list = pool.length ? pool : fallback;
  if(!list.length) return null;

  const k = key(cat,pts);
  if(!state.usedByCatPts.has(k)) state.usedByCatPts.set(k, new Set());
  const used = state.usedByCatPts.get(k);

  if(used.size >= list.length) used.clear();

  let pick = null;
  let guard=0;
  while(guard<400){
    const idx = list[Math.floor(Math.random()*list.length)];
    if(!used.has(idx)){ pick=idx; break; }
    guard++;
  }
  if(pick===null) pick = list[Math.floor(Math.random()*list.length)];
  used.add(pick);
  return {idx:pick, qa:BANK[pick]};
}

/* ============== Modal + Timer ============== */
function openModal(){ $("modalBack").style.display="flex"; }
function closeModal(){
  stopTimer();
  $("modalBack").style.display="none";
  hideAnswer();
  showStealOptions(false);
  state.stealMode=false;
  state.firstTeamTurn=null;
}
function toggleAnswer(){ $("answerBox").classList.toggle("show"); }
function hideAnswer(){ $("answerBox").classList.remove("show"); }

function startTimer(){
  stopTimer();
  state.timer.left = Number($("timerLen").value);
  $("timer").textContent = state.timer.left+"s";
  state.timer.id = setInterval(()=>{
    state.timer.left--;
    $("timer").textContent = state.timer.left+"s";
    if(state.timer.left<=0){
      stopTimer();
      $("timer").textContent = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª â›”";
      beep("bad");
    }
  },1000);
}
function stopTimer(){
  if(state.timer.id){ clearInterval(state.timer.id); state.timer.id=null; }
}

function openCell(cat, pts, btnEl){
  const k = key(cat,pts);
  if(state.usedCells.has(k)) return;

  state.usedCells.add(k);
  btnEl.classList.add("used");

  state.current = {cat, pts, idx:null};
  state.stealMode = false;
  state.firstTeamTurn = state.turn;

  newQuestionSameCell();
  openModal();
}

function newQuestionSameCell(){
  const {cat, pts} = state.current;
  const picked = pickQuestion(cat, pts);

  $("mCat").textContent = `Ø§Ù„ØªØµÙ†ÙŠÙ: ${cat}`;
  $("mPts").textContent = `Ø§Ù„Ù†Ù‚Ø§Ø·: ${pts}`;

  if(!picked){
    $("mQ").textContent = "Ù…Ø§ÙÙŠ Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø­Ø§Ù„ÙŠØ§Ù‹.";
    $("mA").textContent = "â€”";
    $("mMeta").textContent = `Ø¯ÙˆØ±: ${activeTeamName()}`;
    return;
  }

  state.current.idx = picked.idx;
  $("mQ").textContent = picked.qa.q;
  $("mA").textContent = picked.qa.a;
  $("mMeta").textContent = state.stealMode ? `Ù…Ø­Ø§ÙˆÙ„Ø© Ø³Ø±Ù‚Ø© â€” Ø¯ÙˆØ±: ${activeTeamName()}` : `Ø¯ÙˆØ±: ${activeTeamName()}`;

  hideAnswer();
  showStealOptions(false);
  startTimer();
}

/* ============== Result + Steal logic ============== */
function applyResult(correct){
  const pts = state.current.pts || 0;

  if(correct){
    state.scores[state.turn] += pts;
    $("teamScore_"+state.turn).textContent = state.scores[state.turn];
    beep("ok");
    closeModal();
    switchTurn();
    return;
  }

  // Ø®Ø·Ø£
  beep("bad");

  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø­Ø§ÙˆÙ„Ø© Ø³Ø±Ù‚Ø©: Ø®Ù„Ø§Øµ Ù‚ÙÙ„ ÙˆØ¨Ø¯Ù‘Ù„ Ø§Ù„Ø¯ÙˆØ±
  if(state.stealMode){
    closeModal();
    switchTurn();
    return;
  }

  // Ø£ÙˆÙ„ Ù…Ø­Ø§ÙˆÙ„Ø© ØºÙ„Ø·: Ø§Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø± Ø§Ù„Ø³Ø±Ù‚Ø©
  showStealOptions(true);
}

/* ============== Helps ============== */
function useHelp(type, team){
  if(team !== state.turn) return;
  if(state.helpsUsed[team][type]) return;

  state.helpsUsed[team][type]=true;
  const hintBtn = $("hintBtn_"+team);
  const passBtn = $("passBtn_"+team);

  if(type==="hint"){
    if(hintBtn) hintBtn.classList.add("used");
    const a = String($("mA").textContent || "");
    const h = a.length<=4 ? a : (a.slice(0,4)+"â€¦");
    $("mMeta").textContent = `ØªÙ„Ù…ÙŠØ­: ${h}`;
  }
  if(type==="pass"){
    if(passBtn) passBtn.classList.add("used");
    newQuestionSameCell();
  }
  syncTurnPill();
}

/* ============== Buttons wiring ============== */
$("btnRandomCats").addEventListener("click", pickRandomCats);

$("btnStart").addEventListener("click", ()=>{
  if(state.selectedCats.length < 3){
    alert("Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø± 3 ØªØµÙ†ÙŠÙØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return;
  }
  state.gameCats = [...state.selectedCats];
  saveCats(state.gameCats);

  $("pickerCard").style.display="none";
  $("gameArea").style.display="grid";

  if(BANK.length < 30){
    alert("Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØµØºÙŠØ±/ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„. ØªØ£ÙƒØ¯ Ø¥Ù† Ù…Ù„Ù bank.js Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ…Ø±ÙÙˆØ¹ ØµØ­.");
  }

  buildTeams();
  buildBoard();
});

$("btnPicker").addEventListener("click", ()=>{
  closeModal();
  $("gameArea").style.display="none";
  $("pickerCard").style.display="block";
  buildPicker();
});

$("btnResetBoard").addEventListener("click", buildBoard);

$("btnHardReset").addEventListener("click", ()=>{
  closeModal();
  $("gameArea").style.display="none";
  $("pickerCard").style.display="block";
  $("timer").textContent="â€”";
  buildPicker();
});

$("btnSwitchTurn").addEventListener("click", switchTurn);

$("btnStats").addEventListener("click", ()=>{
  const cats = new Set(BANK.map(x=>x.cat)).size;
  alert(`Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ø§Ù„Ø¨Ù†Ùƒ: ${BANK.length}\nØ¹Ø¯Ø¯ ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø¨Ù†Ùƒ: ${cats}\nØªØµÙ†ÙŠÙØ§Øª Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¹Ø¨Ø©: ${state.gameCats.length}`);
});

$("btnNewQ").addEventListener("click", newQuestionSameCell);
$("btnToggleA").addEventListener("click", toggleAnswer);
$("btnClose").addEventListener("click", closeModal);
$("btnCorrect").addEventListener("click", ()=>applyResult(true));
$("btnWrong").addEventListener("click", ()=>applyResult(false));

$("btnStealTry").addEventListener("click", ()=>{
  // Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ ÙŠØ­Ø§ÙˆÙ„ ÙŠØ¬Ø§ÙˆØ¨ Ù†ÙØ³ Ø§Ù„Ø³Ø¤Ø§Ù„
  switchTurn();
  state.stealMode = true;
  showStealOptions(false);
  $("mMeta").textContent = `Ù…Ø­Ø§ÙˆÙ„Ø© Ø³Ø±Ù‚Ø© â€” Ø¯ÙˆØ±: ${activeTeamName()}`;
  hideAnswer();
  startTimer(); // ÙˆÙ‚Øª Ø¬Ø¯ÙŠØ¯ Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø³Ø±Ù‚Ø©
});

$("btnNoPoints").addEventListener("click", ()=>{
  closeModal();
  switchTurn();
});

$("modalBack").addEventListener("click", (e)=>{
  if(e.target.id==="modalBack") closeModal();
});

/* Ø§Ø®ØªØµØ§Ø±Ø§Øª */
document.addEventListener("keydown",(e)=>{
  const k = e.key.toLowerCase();
  if(k==="t") switchTurn();
  if($("modalBack").style.display==="flex"){
    if(k==="a") toggleAnswer();
    if(k==="n") newQuestionSameCell();
    if(k==="escape") closeModal();
  }
});

/* INIT */
buildPicker();
</script>
</body>
</html>
